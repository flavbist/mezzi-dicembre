<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpecialVehicles Archive - Cloud Database</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel per JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f1f5f9; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .modal-overlay { background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(10px); }
        .card-zoom:hover img { transform: scale(1.1); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-storage.js";

        // Espongo le funzioni necessarie globalmente per React
        window.FB = { 
            initializeApp, getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy,
            getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken,
            getStorage, ref, uploadBytes, getDownloadURL
        };
        window.dispatchEvent(new Event('fb-lib-ready'));
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const App = () => {
            const [ready, setReady] = useState(false);
            const [user, setUser] = useState(null);
            const [vehicles, setVehicles] = useState([]);
            const [view, setView] = useState('home');
            const [isAdmin, setIsAdmin] = useState(false);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            const db = useRef(null);
            const auth = useRef(null);
            const storage = useRef(null);

            // Configurazione e Costanti
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'mezzi-speciali-2025-v1';
            const firebaseConfig = typeof __firebase_config !== 'undefined' 
                ? JSON.parse(__firebase_config) 
                : {
                    apiKey: "AIzaSyC0ge7t486bOmNHiQcDWdtr3IbxlCGzAWM",
                    authDomain: "mezzi-2.firebaseapp.com",
                    projectId: "mezzi-2",
                    storageBucket: "mezzi-2.firebasestorage.app",
                    messagingSenderId: "258617794260",
                    appId: "1:258617794260:web:3d449f24017df4615fa541"
                };

            // 1. Attesa libreria Firebase
            useEffect(() => {
                if (window.FB) setReady(true);
                else window.addEventListener('fb-lib-ready', () => setReady(true));
            }, []);

            // 2. Inizializzazione Auth e Storage
            useEffect(() => {
                if (!ready) return;

                const app = window.FB.initializeApp(firebaseConfig);
                db.current = window.FB.getFirestore(app);
                auth.current = window.FB.getAuth(app);
                storage.current = window.FB.getStorage(app);

                const performAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await window.FB.signInWithCustomToken(auth.current, __initial_auth_token);
                        } else {
                            await window.FB.signInAnonymously(auth.current);
                        }
                    } catch (err) {
                        console.error("Auth Error:", err);
                        setError("Errore connessione Cloud. Verifica API Key.");
                    }
                };

                performAuth();

                const unsubscribeAuth = window.FB.onAuthStateChanged(auth.current, (u) => {
                    setUser(u);
                    if (u) {
                        console.log("Sistema Pronto. UID:", u.uid);
                    } else {
                        setLoading(false);
                    }
                });

                return () => unsubscribeAuth();
            }, [ready]);

            // 3. Caricamento Dati in tempo reale
            useEffect(() => {
                if (!user || !db.current) return;

                const colRef = window.FB.collection(db.current, 'artifacts', appId, 'public', 'data', 'vehicles');
                
                const unsubscribe = window.FB.onSnapshot(
                    window.FB.query(colRef),
                    (snapshot) => {
                        const data = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                        setVehicles(data);
                        setLoading(false);
                    },
                    (err) => {
                        console.error("Firestore Read Error:", err);
                        setError("Errore sincronizzazione dati.");
                        setLoading(false);
                    }
                );

                return () => unsubscribe();
            }, [user, appId]);

            const generateAdCode = (plate) => {
                const date = new Date();
                const random = Math.random().toString(36).substring(2, 5).toUpperCase();
                return `SV-${date.getFullYear()}${String(date.getMonth()+1).padStart(2,'0')}-${random}`;
            };

            const handleAddVehicle = async (data) => {
                if (!user || !db.current) throw new Error("Connessione non ancora stabilita.");
                
                try {
                    const colRef = window.FB.collection(db.current, 'artifacts', appId, 'public', 'data', 'vehicles');
                    await window.FB.addDoc(colRef, {
                        plate: data.plate.toUpperCase(),
                        description: data.description,
                        price: Number(data.price),
                        imageUrl: data.imageUrl,
                        adCode: generateAdCode(data.plate),
                        createdAt: Date.now(),
                        createdBy: user.uid
                    });
                } catch (err) {
                    console.error("Errore scrittura:", err);
                    throw new Error("Salvataggio fallito nel database.");
                }
            };

            const handleDeleteVehicle = async (id) => {
                if (!user || !db.current) return;
                try {
                    const docRef = window.FB.doc(db.current, 'artifacts', appId, 'public', 'data', 'vehicles', id);
                    await window.FB.deleteDoc(docRef);
                } catch (err) {
                    console.error("Delete Error:", err);
                }
            };

            if (loading) return (
                <div className="min-h-screen flex items-center justify-center bg-slate-900 text-white font-bold uppercase tracking-widest text-xs">
                    <div className="text-center">
                        <i className="fa-solid fa-circle-notch fa-spin text-3xl text-orange-500 mb-4"></i>
                        <p>Inizializzazione Archivio...</p>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen flex flex-col">
                    <header className="bg-slate-900 text-white shadow-xl border-b border-orange-500/20 sticky top-0 z-50">
                        <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                            <div className="flex items-center gap-3 cursor-pointer" onClick={() => setView('home')}>
                                <i className="fa-solid fa-truck-pickup text-2xl text-orange-500"></i>
                                <div>
                                    <h1 className="text-xl font-bold leading-none italic">SpecialVehicles</h1>
                                    <p className="text-[9px] text-green-500 font-bold uppercase tracking-widest mt-1">● Cloud Storage Attivo</p>
                                </div>
                            </div>
                            <button 
                                onClick={() => setView(view === 'home' ? 'admin' : 'home')}
                                className="bg-slate-800 text-slate-300 px-4 py-2 rounded-full text-xs font-bold hover:bg-slate-700 transition-colors"
                            >
                                {view === 'home' ? <><i className="fa-solid fa-lock mr-2"></i>Area Riservata</> : <><i className="fa-solid fa-house mr-2"></i>Torna alla Vetrina</>}
                            </button>
                        </div>
                    </header>

                    <main className="flex-grow max-w-7xl mx-auto px-4 py-8 w-full fade-in">
                        {error && (
                            <div className="bg-red-500 text-white p-4 rounded-2xl mb-6 flex items-center gap-4 shadow-lg animate-pulse">
                                <i className="fa-solid fa-triangle-exclamation text-xl"></i>
                                <span className="font-bold text-sm uppercase">{error}</span>
                            </div>
                        )}
                        
                        {view === 'home' && <PublicGallery vehicles={vehicles} />}
                        {view === 'admin' && !isAdmin && <AdminLogin onLogin={(u,p) => (u.toUpperCase()==='FLAVIO' && p==='1710' ? setIsAdmin(true) : false)} />}
                        {view === 'admin' && isAdmin && <AdminDashboard vehicles={vehicles} onAdd={handleAddVehicle} onDelete={handleDeleteVehicle} storage={storage.current} />}
                    </main>

                    <footer className="bg-slate-900 text-slate-500 py-6 text-center text-[10px] uppercase font-bold tracking-widest border-t border-slate-800">
                        © 2025 SpecialVehicles - Powered by Firebase Storage & Firestore
                    </footer>
                </div>
            );
        };

        const PublicGallery = ({ vehicles }) => {
            const [selected, setSelected] = useState(null);
            const [search, setSearch] = useState('');

            const filtered = vehicles.filter(v => 
                v.plate?.toLowerCase().includes(search.toLowerCase()) || 
                v.description?.toLowerCase().includes(search.toLowerCase())
            ).sort((a,b) => b.createdAt - a.createdAt);

            return (
                <div className="space-y-8">
                    <div className="flex flex-col md:flex-row justify-between items-center gap-6">
                        <h2 className="text-3xl font-black text-slate-800 uppercase italic underline decoration-orange-500 decoration-4 underline-offset-8">Vetrina Mezzi</h2>
                        <div className="relative w-full md:w-80">
                            <i className="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                            <input 
                                type="text" placeholder="Cerca targa o modello..." 
                                className="w-full pl-12 pr-4 py-3 bg-white border-2 border-transparent rounded-2xl outline-none focus:border-orange-500 shadow-sm transition-all"
                                value={search} onChange={e => setSearch(e.target.value)}
                            />
                        </div>
                    </div>

                    {filtered.length === 0 ? (
                        <div className="text-center py-20 text-slate-400 bg-white rounded-[3rem] border-2 border-dashed border-slate-200">
                            <i className="fa-solid fa-box-open text-4xl mb-4"></i>
                            <p className="font-bold uppercase text-xs">Archivio vuoto o nessun risultato</p>
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                            {filtered.map(v => (
                                <div key={v.id} onClick={() => setSelected(v)} className="bg-white rounded-[2.5rem] overflow-hidden shadow-sm hover:shadow-xl transition-all cursor-pointer border border-slate-100 card-zoom flex flex-col group">
                                    <div className="aspect-[4/3] bg-slate-100 overflow-hidden relative">
                                        <img src={v.imageUrl} className="w-full h-full object-cover transition-transform duration-500" />
                                        <div className="absolute top-4 left-4 bg-slate-900/80 text-white px-3 py-1 rounded-full font-mono text-[9px] font-bold">{v.adCode}</div>
                                        <div className="absolute bottom-4 right-4 bg-orange-600 text-white px-3 py-1 rounded-lg font-mono font-bold text-xs shadow-lg uppercase tracking-wider">{v.plate}</div>
                                    </div>
                                    <div className="p-6 flex-grow flex flex-col">
                                        <h3 className="font-bold text-slate-800 text-lg mb-4 uppercase line-clamp-2 h-12 leading-tight">{v.description}</h3>
                                        <div className="flex justify-between items-center mt-auto border-t pt-4 border-slate-50">
                                            <span className="text-2xl font-black text-slate-900">€ {Number(v.price).toLocaleString('it-IT')}</span>
                                            <div className="w-8 h-8 rounded-full bg-orange-50 flex items-center justify-center text-orange-500 group-hover:bg-orange-500 group-hover:text-white transition-all">
                                                <i className="fa-solid fa-arrow-right text-xs"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {selected && (
                        <div className="fixed inset-0 z-[100] modal-overlay flex items-center justify-center p-4" onClick={() => setSelected(null)}>
                            <div className="bg-white rounded-[3rem] max-w-xl w-full p-8 relative shadow-2xl animate-in zoom-in-95 duration-200" onClick={e => e.stopPropagation()}>
                                <button onClick={() => setSelected(null)} className="absolute top-6 right-6 text-slate-300 hover:text-orange-500 transition-colors"><i className="fa-solid fa-times-circle text-3xl"></i></button>
                                <img src={selected.imageUrl} className="w-full aspect-video object-cover rounded-[2rem] mb-6 shadow-md" />
                                <div className="mb-2 font-mono text-orange-500 font-bold text-xs">RIF: {selected.adCode}</div>
                                <h2 className="text-2xl font-black text-slate-800 uppercase mb-4">{selected.description}</h2>
                                <div className="bg-slate-50 p-6 rounded-3xl flex justify-between items-center">
                                    <div className="text-4xl font-black text-slate-900">€ {Number(selected.price).toLocaleString('it-IT')}</div>
                                    <button className="bg-slate-900 text-white px-6 py-3 rounded-xl font-bold uppercase text-xs shadow-lg hover:bg-orange-600 transition-colors">Contatta Venditore</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const AdminLogin = ({ onLogin }) => {
            const [u, setU] = useState('');
            const [p, setP] = useState('');
            return (
                <div className="flex justify-center py-20">
                    <div className="bg-white p-10 rounded-[3rem] shadow-xl w-full max-w-md border-b-4 border-orange-500">
                        <div className="text-center mb-8">
                            <i className="fa-solid fa-shield-halved text-4xl text-orange-500 mb-4"></i>
                            <h2 className="text-xl font-black uppercase italic">Accesso Gestione</h2>
                        </div>
                        <div className="space-y-4">
                            <input type="text" placeholder="Nome Utente" className="w-full p-4 bg-slate-50 rounded-2xl outline-none border-2 border-transparent focus:border-orange-500 font-bold uppercase" value={u} onChange={e => setU(e.target.value)} />
                            <input type="password" placeholder="Password" className="w-full p-4 bg-slate-50 rounded-2xl outline-none border-2 border-transparent focus:border-orange-500" value={p} onChange={e => setP(e.target.value)} />
                            <button onClick={() => onLogin(u,p)} className="w-full py-4 bg-orange-600 text-white rounded-2xl font-bold uppercase shadow-lg hover:bg-orange-700 transition-all">Accedi al Cloud</button>
                        </div>
                    </div>
                </div>
            );
        };

        const AdminDashboard = ({ vehicles, onAdd, onDelete, storage }) => {
            const [form, setForm] = useState({ plate: '', description: '', price: '' });
            const [file, setFile] = useState(null);
            const [previewUrl, setPreviewUrl] = useState('');
            const [isSaving, setIsSaving] = useState(false);
            const [status, setStatus] = useState('');

            const handleFileChange = (e) => {
                const selectedFile = e.target.files[0];
                if (!selectedFile) return;
                
                setFile(selectedFile);
                setPreviewUrl(URL.createObjectURL(selectedFile));
                setStatus('File selezionato.');
            };

            const submit = async () => {
                if (!form.plate || !form.description || !form.price || !file) {
                    alert("Attenzione: Compila tutti i campi e seleziona una foto!");
                    return;
                }
                
                setIsSaving(true);
                setStatus('Caricamento foto su Storage...');
                
                try {
                    // 1. Caricamento su Firebase Storage
                    const fileName = `${Date.now()}-${file.name}`;
                    const storageRef = window.FB.ref(storage, `vehicles/${fileName}`);
                    const uploadResult = await window.FB.uploadBytes(storageRef, file);
                    
                    // 2. Ottenimento URL pubblico
                    const downloadUrl = await window.FB.getDownloadURL(uploadResult.ref);
                    
                    setStatus('Aggiornamento database...');
                    
                    // 3. Salvataggio su Firestore con il link reale
                    await onAdd({
                        ...form,
                        imageUrl: downloadUrl
                    });
                    
                    setForm({ plate: '', description: '', price: '' });
                    setFile(null);
                    setPreviewUrl('');
                    setStatus('Veicolo salvato con successo!');
                    setTimeout(() => setStatus(''), 3000);
                } catch(e) { 
                    console.error(e);
                    alert("Errore critico: " + e.message);
                    setStatus('Errore caricamento.');
                } finally {
                    setIsSaving(false);
                }
            };

            return (
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-10">
                    <div className="bg-white p-8 rounded-[3rem] shadow-lg border border-slate-100 h-fit sticky top-24">
                        <h3 className="font-black mb-6 uppercase text-sm italic border-l-4 border-orange-500 pl-4">Nuovo Inserimento (Storage)</h3>
                        <div className="space-y-4">
                            <label className="block border-2 border-dashed border-slate-200 rounded-2xl p-4 text-center cursor-pointer hover:border-orange-500 overflow-hidden aspect-video relative group bg-slate-50 transition-all">
                                {previewUrl ? 
                                    <img src={previewUrl} className="w-full h-full object-cover rounded-xl" /> : 
                                    <div className="flex flex-col items-center justify-center h-full text-slate-400">
                                        <i className="fa-solid fa-cloud-arrow-up text-3xl mb-2 group-hover:scale-110 transition-transform"></i>
                                        <span className="text-[10px] font-bold uppercase tracking-widest">Carica Foto Reale</span>
                                    </div>
                                }
                                <input type="file" accept="image/*" className="hidden" onChange={handleFileChange} />
                            </label>
                            
                            {status && <div className="text-[10px] font-bold text-orange-600 animate-pulse text-center uppercase">{status}</div>}

                            <input placeholder="TARGA" className="w-full p-4 bg-slate-50 rounded-xl outline-none font-bold uppercase border border-slate-100 focus:bg-white transition-all" value={form.plate} onChange={e => setForm({...form, plate: e.target.value})} />
                            <input placeholder="MODELLO E ALLESTIMENTO" className="w-full p-4 bg-slate-50 rounded-xl outline-none font-bold border border-slate-100 focus:bg-white transition-all" value={form.description} onChange={e => setForm({...form, description: e.target.value})} />
                            <input type="number" placeholder="PREZZO €" className="w-full p-4 bg-slate-50 rounded-xl outline-none font-black text-orange-600 border border-slate-100 focus:bg-white transition-all text-xl" value={form.price} onChange={e => setForm({...form, price: e.target.value})} />
                            
                            <button onClick={submit} disabled={isSaving} className="w-full py-5 bg-slate-900 text-white rounded-2xl font-bold uppercase shadow-lg disabled:opacity-50 hover:bg-orange-600 transition-all flex items-center justify-center gap-3">
                                {isSaving ? <i className="fa-solid fa-circle-notch fa-spin"></i> : <i className="fa-solid fa-check-double"></i>}
                                PUBBLICA SUL CLOUD
                            </button>
                        </div>
                    </div>

                    <div className="lg:col-span-2 bg-white rounded-[3rem] shadow-lg overflow-hidden border border-slate-100">
                        <div className="bg-slate-900 p-6 text-white flex justify-between items-center">
                            <h3 className="font-bold uppercase text-xs italic tracking-widest">Gestione Inventario Live</h3>
                            <span className="bg-orange-600 text-[10px] px-3 py-1 rounded-full font-black uppercase tracking-tighter">{vehicles.length} Veicoli Totali</span>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead className="bg-slate-50 text-slate-400 text-[9px] uppercase font-black">
                                    <tr>
                                        <th className="p-6 text-left">Foto Originale</th>
                                        <th className="p-6 text-left">Modello</th>
                                        <th className="p-6 text-right">Targa</th>
                                        <th className="p-6 text-right">Azioni</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {vehicles.length === 0 ? (
                                        <tr><td colSpan="4" className="p-16 text-center text-slate-300 italic uppercase text-xs tracking-widest font-bold">Nessun veicolo nel database</td></tr>
                                    ) : (
                                        vehicles.map(v => (
                                            <tr key={v.id} className="hover:bg-slate-50 transition-colors group">
                                                <td className="p-4">
                                                    <div className="w-16 h-12 rounded-lg overflow-hidden shadow-sm border border-slate-200">
                                                        <img src={v.imageUrl} className="w-full h-full object-cover" />
                                                    </div>
                                                </td>
                                                <td className="p-4">
                                                    <div className="font-bold text-slate-800 uppercase text-xs truncate max-w-[200px]">{v.description}</div>
                                                </td>
                                                <td className="p-4 text-right text-xs font-mono font-bold uppercase text-slate-500">{v.plate}</td>
                                                <td className="p-4 text-right">
                                                    <button onClick={() => confirm("Eliminare permanentemente questo veicolo?") && onDelete(v.id)} className="w-9 h-9 rounded-full text-slate-200 hover:text-red-600 hover:bg-red-50 transition-all">
                                                        <i className="fa-solid fa-trash-can"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
