<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpecialVehicles Archive - Cloud Database</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel per JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f1f5f9; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .modal-overlay { background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(10px); }
        .search-glow:focus { box-shadow: 0 0 0 4px rgba(234, 88, 12, 0.1); }
        .card-zoom:hover img { transform: scale(1.1); }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        window.FirebaseLib = { 
            initializeApp, getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, 
            getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken
        };
        
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        /**
         * CONFIGURAZIONE FIREBASE
         */
       // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyC0ge7t486bOmNHiQcDWdtr3IbxlCGzAWM",
  authDomain: "mezzi-2.firebaseapp.com",
  projectId: "mezzi-2",
  storageBucket: "mezzi-2.firebasestorage.app",
  messagingSenderId: "258617794260",
  appId: "1:258617794260:web:3d449f24017df4615fa541"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
        // Funzione per generare un codice annuncio univoco (es: SV-202512-AB123)
        const generateAdCode = (plate) => {
            const date = new Date();
            const yearMonth = `${date.getFullYear()}${String(date.getMonth() + 1).padStart(2, '0')}`;
            const random = Math.random().toString(36).substring(2, 5).toUpperCase();
            const plateClean = (plate || 'XX').replace(/\s/g, '').substring(0, 2).toUpperCase();
            return `SV-${yearMonth}-${plateClean}${random}`;
        };

        const App = () => {
            const [fbReady, setFbReady] = useState(false);
            const [view, setView] = useState('home'); 
            const [vehicles, setVehicles] = useState([]);
            const [user, setUser] = useState(null);
            const [isAdmin, setIsAdmin] = useState(false);
            const [loading, setLoading] = useState(true);
            const [errorMsg, setErrorMsg] = useState(null);

            const getActiveConfig = () => {
                if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                    return JSON.parse(__firebase_config);
                }
                if (MANUAL_FIREBASE_CONFIG.apiKey !== "INSERISCI_QUI") {
                    return MANUAL_FIREBASE_CONFIG;
                }
                return null;
            };

            useEffect(() => {
                if (window.FirebaseLib) setFbReady(true);
                else window.addEventListener('firebase-ready', () => setFbReady(true));
            }, []);

            useEffect(() => {
                if (!fbReady) return;
                
                const config = getActiveConfig();
                if (!config) {
                    setErrorMsg("Configurazione mancante: inserisci le chiavi MANUAL_FIREBASE_CONFIG nel codice.");
                    setLoading(false);
                    return;
                }

                const { initializeApp, getFirestore, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } = window.FirebaseLib;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'special-vehicles-archive';
                
                const app = initializeApp(config);
                const auth = getAuth(app);
                const db = getFirestore(app);

                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (err) { 
                        setErrorMsg("Errore Autenticazione: verifica di aver abilitato 'Accesso Anonimo' su Firebase."); 
                    }
                };
                initAuth();

                const unsubscribeAuth = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    if (u) {
                        const { collection, query, onSnapshot } = window.FirebaseLib;
                        const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'vehicles');
                        const q = query(colRef);
                        
                        const unsubscribeData = onSnapshot(q, (snapshot) => {
                            setVehicles(snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id })));
                            setLoading(false);
                        }, (err) => { 
                            setErrorMsg("Errore Database: verifica le Regole di Sicurezza di Firestore."); 
                            setLoading(false); 
                        });
                        return () => unsubscribeData();
                    }
                });
                return () => unsubscribeAuth();
            }, [fbReady]);

            const handleLogin = (username, password) => {
                if (username && username.trim().toUpperCase() === 'FLAVIO' && password === '1710') {
                    setIsAdmin(true);
                    return true;
                }
                return false;
            };

            const addVehicle = async (data) => {
                try {
                    const { getFirestore, collection, addDoc, initializeApp } = window.FirebaseLib;
                    const db = getFirestore(initializeApp(getActiveConfig()));
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'special-vehicles-archive';
                    
                    const finalData = {
                        ...data,
                        adCode: generateAdCode(data.plate),
                        createdAt: Date.now()
                    };

                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'vehicles'), finalData);
                } catch (err) {
                    alert("Errore salvataggio mezzo.");
                }
            };

            const deleteVehicle = async (id) => {
                try {
                    const { getFirestore, doc, deleteDoc, initializeApp } = window.FirebaseLib;
                    const db = getFirestore(initializeApp(getActiveConfig()));
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'special-vehicles-archive';
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'vehicles', id));
                } catch (err) {
                    console.error(err);
                }
            };

            if (loading && !errorMsg) return (
                <div className="min-h-screen flex items-center justify-center bg-slate-900 text-white font-sans">
                    <div className="text-center"><i className="fa-solid fa-circle-notch fa-spin text-4xl text-orange-500 mb-4"></i><p className="tracking-widest uppercase text-xs font-bold">Accesso al Cloud...</p></div>
                </div>
            );

            return (
                <div className="min-h-screen flex flex-col font-sans">
                    <header className="bg-slate-900 text-white shadow-xl border-b border-orange-500/20 sticky top-0 z-50">
                        <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                            <div className="flex items-center gap-3 cursor-pointer" onClick={() => setView('home')}>
                                <i className="fa-solid fa-truck-monster text-2xl text-orange-500"></i>
                                <div><h1 className="text-xl font-bold">SpecialVehicles Archive</h1><p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest leading-none">Gestione Flotta</p></div>
                            </div>
                            <Button variant="secondary" onClick={() => setView(view === 'home' ? 'admin' : 'home')} className="!rounded-full text-xs">
                                {view === 'home' ? <><i className="fa-solid fa-user-shield"></i> Staff</> : <><i className="fa-solid fa-house"></i> Home</>}
                            </Button>
                        </div>
                    </header>

                    <main className="flex-grow max-w-7xl mx-auto px-4 py-8 w-full fade-in">
                        {errorMsg && (
                            <div className="bg-orange-50 border-l-4 border-orange-500 text-orange-800 p-6 mb-8 rounded-r-2xl shadow-sm">
                                <div className="flex items-center gap-3 mb-2"><i className="fa-solid fa-triangle-exclamation text-xl"></i><h3 className="font-black text-lg">Configurazione Richiesta</h3></div>
                                <p className="text-sm font-medium">{errorMsg}</p>
                            </div>
                        )}
                        {view === 'home' && <PublicGallery vehicles={vehicles} />}
                        {view === 'admin' && !isAdmin && <AdminLogin onLogin={handleLogin} />}
                        {view === 'admin' && isAdmin && <AdminDashboard vehicles={vehicles} onAdd={addVehicle} onDelete={deleteVehicle} />}
                    </main>

                    <footer className="bg-slate-900 text-slate-500 py-6 text-center text-[10px] uppercase font-bold tracking-widest">
                        SpecialVehicles Cloud Database &copy; 2025
                    </footer>
                </div>
            );
        };

        const Button = ({ children, onClick, variant = 'primary', className = '', disabled = false }) => {
            const styles = {
                primary: "bg-orange-600 text-white hover:bg-orange-700 shadow-lg shadow-orange-500/20",
                secondary: "bg-slate-800 text-slate-300 hover:bg-slate-700",
                danger: "bg-red-500 text-white hover:bg-red-600"
            };
            return (
                <button disabled={disabled} onClick={onClick} className={`px-5 py-2.5 rounded-xl font-bold transition-all active:scale-95 disabled:opacity-50 flex items-center justify-center gap-2 ${styles[variant]} ${className}`}>
                    {children}
                </button>
            );
        };

        const PublicGallery = ({ vehicles }) => {
            const [selected, setSelected] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');

            const filtered = useMemo(() => vehicles.filter(v => 
                v.plate?.toLowerCase().includes(searchTerm.toLowerCase()) || 
                v.description?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                v.adCode?.toLowerCase().includes(searchTerm.toLowerCase())
            ), [vehicles, searchTerm]);

            const handleContact = (v) => {
                const subject = encodeURIComponent(`Interesse per Mezzo Speciale: ${v.adCode}`);
                const body = encodeURIComponent(`Salve,\n\nRichiedo maggiori informazioni per il seguente mezzo:\n\nCodice Annuncio: ${v.adCode}\nModello: ${v.description}\nTarga: ${v.plate}\nPrezzo: € ${Number(v.price).toLocaleString('it-IT')}\n\nIn attesa di un vostro riscontro.\nCordiali saluti.`);
                window.location.href = `mailto:info@specialvehicles.com?subject=${subject}&body=${body}`;
            };

            return (
                <div className="space-y-8">
                    <div className="flex flex-col md:flex-row justify-between items-center gap-6">
                        <h2 className="text-3xl font-black text-slate-800 uppercase tracking-tighter italic">La Nostra Flotta</h2>
                        <div className="relative w-full md:w-96">
                            <i className="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                            <input 
                                type="text" placeholder="Cerca targa, modello o codice annuncio..." 
                                className="w-full pl-12 pr-4 py-4 bg-white border-2 border-transparent rounded-2xl outline-none focus:border-orange-500 shadow-sm transition-all"
                                value={searchTerm} onChange={e => setSearchTerm(e.target.value)}
                            />
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {filtered.map(v => (
                            <div key={v.id} onClick={() => setSelected(v)} className="bg-white rounded-[2.5rem] overflow-hidden shadow-sm hover:shadow-2xl transition-all cursor-pointer group border border-slate-100 card-zoom flex flex-col">
                                <div className="aspect-[4/3] bg-slate-100 overflow-hidden relative">
                                    {v.images?.[0] ? <img src={v.images[0]} className="w-full h-full object-cover transition-transform duration-700" /> : <div className="w-full h-full flex items-center justify-center text-slate-300"><i className="fa-solid fa-truck text-5xl"></i></div>}
                                    <div className="absolute top-4 left-4 bg-slate-900/90 text-white px-3 py-1 rounded-full font-mono font-bold text-[10px] backdrop-blur uppercase tracking-widest">{v.adCode || 'PRO-MODE'}</div>
                                    <div className="absolute bottom-4 right-4 bg-orange-600 text-white px-3 py-1 rounded-lg font-mono font-bold text-xs shadow-lg">{v.plate}</div>
                                </div>
                                <div className="p-8 flex-grow flex flex-col">
                                    <h3 className="font-bold text-slate-800 text-xl mb-4 line-clamp-2 leading-tight h-14">{v.description}</h3>
                                    <div className="flex justify-between items-center mt-auto">
                                        <span className="text-3xl font-black text-slate-900">€ {Number(v.price).toLocaleString('it-IT')}</span>
                                        <div className="w-10 h-10 rounded-full bg-orange-50 flex items-center justify-center text-orange-500 group-hover:bg-orange-500 group-hover:text-white transition-colors">
                                            <i className="fa-solid fa-arrow-right"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>

                    {selected && (
                        <div className="fixed inset-0 z-[100] modal-overlay flex items-center justify-center p-4 overflow-y-auto" onClick={() => setSelected(null)}>
                            <div className="bg-white rounded-[3rem] max-w-2xl w-full p-8 md:p-12 relative shadow-2xl my-auto" onClick={e => e.stopPropagation()}>
                                <button onClick={() => setSelected(null)} className="absolute top-8 right-8 text-slate-300 hover:text-orange-500 transition-colors"><i className="fa-solid fa-circle-xmark text-4xl"></i></button>
                                
                                <div className="aspect-video rounded-[2rem] overflow-hidden mb-8 shadow-inner bg-slate-100">
                                    {selected.images?.[0] && <img src={selected.images[0]} className="w-full h-full object-cover" />}
                                </div>

                                <div className="flex flex-col md:flex-row justify-between items-start gap-4 mb-6">
                                    <div>
                                        <span className="text-orange-600 font-bold text-xs tracking-widest uppercase block mb-1">Codice Annuncio: {selected.adCode}</span>
                                        <h2 className="text-4xl font-black text-slate-800 leading-none">{selected.description}</h2>
                                    </div>
                                    <div className="bg-slate-900 text-white px-6 py-2 rounded-2xl font-mono font-bold text-xl">{selected.plate}</div>
                                </div>

                                <div className="bg-slate-50 p-8 rounded-[2rem] border border-slate-100 flex flex-col md:flex-row justify-between items-center gap-8 mt-10">
                                    <div className="text-5xl font-black text-slate-900">€ {Number(selected.price).toLocaleString('it-IT')}</div>
                                    <Button variant="primary" className="w-full md:w-auto px-10 py-5 text-lg" onClick={() => handleContact(selected)}>
                                        <i className="fa-solid fa-envelope"></i> Richiedi Info
                                    </Button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const AdminLogin = ({ onLogin }) => {
            const [user, setUser] = useState('');
            const [pass, setPass] = useState('');
            return (
                <div className="flex justify-center py-20">
                    <div className="bg-white p-12 rounded-[3rem] shadow-2xl w-full max-w-md text-center border-b-8 border-orange-500">
                        <div className="w-20 h-20 bg-slate-900 rounded-3xl flex items-center justify-center mx-auto mb-8 shadow-lg shadow-slate-200">
                            <i className="fa-solid fa-key text-3xl text-orange-500"></i>
                        </div>
                        <h2 className="text-3xl font-black mb-10 text-slate-800 tracking-tighter uppercase">Accesso Area Riservata</h2>
                        <div className="space-y-4 text-left">
                            <input type="text" placeholder="ID Utente" className="w-full p-5 bg-slate-50 border-2 border-transparent rounded-2xl outline-none focus:border-orange-500 transition-all font-bold" value={user} onChange={e => setUser(e.target.value)} />
                            <input type="password" placeholder="Password" className="w-full p-5 bg-slate-50 border-2 border-transparent rounded-2xl outline-none focus:border-orange-500 transition-all font-bold" value={pass} onChange={e => setPass(e.target.value)} />
                        </div>
                        <Button variant="primary" className="w-full py-5 mt-10 text-lg uppercase tracking-widest" onClick={() => onLogin(user, pass)}>Sblocca Accesso</Button>
                    </div>
                </div>
            );
        };

        const AdminDashboard = ({ vehicles, onAdd, onDelete }) => {
            const [form, setForm] = useState({ plate: '', description: '', price: '' });
            const [images, setImages] = useState([]);
            const [isUploading, setIsUploading] = useState(false);

            const handleFile = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setIsUploading(true);
                const reader = new FileReader();
                reader.onload = (ev) => {
                    setImages([ev.target.result]);
                    setIsUploading(false);
                };
                reader.readAsDataURL(file);
            };

            const handleSubmit = () => {
                if (!form.plate || !form.description || !form.price) return alert("Compila tutti i campi obbligatori.");
                onAdd({...form, images});
                setForm({ plate: '', description: '', price: '' });
                setImages([]);
            };

            return (
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-12">
                    <div className="lg:col-span-1 bg-white p-10 rounded-[3rem] shadow-xl h-fit border border-slate-100">
                        <h3 className="text-2xl font-black mb-8 text-slate-800 tracking-tight italic">Nuovo Inserimento</h3>
                        <div className="space-y-5">
                            <div>
                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1 mb-2 block">Targa</label>
                                <input type="text" placeholder="es. AA 123 BB" className="w-full p-5 bg-slate-50 rounded-2xl outline-none font-bold uppercase focus:ring-2 ring-orange-100 transition-all" value={form.plate} onChange={e => setForm({...form, plate: e.target.value})} />
                            </div>
                            <div>
                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1 mb-2 block">Modello</label>
                                <input type="text" placeholder="Nome completo mezzo" className="w-full p-5 bg-slate-50 rounded-2xl outline-none focus:ring-2 ring-orange-100 transition-all" value={form.description} onChange={e => setForm({...form, description: e.target.value})} />
                            </div>
                            <div>
                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1 mb-2 block">Prezzo (€)</label>
                                <input type="number" placeholder="0.00" className="w-full p-5 bg-slate-50 rounded-2xl outline-none font-black text-orange-600 focus:ring-2 ring-orange-100 transition-all" value={form.price} onChange={e => setForm({...form, price: e.target.value})} />
                            </div>
                            
                            <div className="pt-4">
                                <label className="w-full flex flex-col items-center px-4 py-8 bg-slate-50 text-slate-400 rounded-[2rem] border-2 border-dashed border-slate-200 cursor-pointer hover:bg-orange-50 hover:border-orange-200 transition-all group">
                                    {isUploading ? <i className="fa-solid fa-circle-notch fa-spin text-2xl text-orange-500"></i> : (
                                        <>
                                            <i className="fa-solid fa-cloud-arrow-up text-3xl mb-3 group-hover:text-orange-500"></i>
                                            <span className="text-xs font-bold uppercase tracking-widest">Carica Foto</span>
                                        </>
                                    )}
                                    <input type="file" onChange={handleFile} className="hidden" />
                                </label>
                                {images.length > 0 && <p className="text-center text-[10px] text-green-500 font-bold mt-2 uppercase tracking-widest">Immagine pronta per l'invio</p>}
                            </div>

                            <Button variant="primary" className="w-full py-5 mt-6 text-lg" onClick={handleSubmit}>
                                <i className="fa-solid fa-plus-circle"></i> Aggiungi al Database
                            </Button>
                        </div>
                    </div>

                    <div className="lg:col-span-2 bg-white rounded-[3rem] shadow-xl overflow-hidden border border-slate-100">
                        <div className="bg-slate-900 p-8 text-white flex justify-between items-center">
                            <h3 className="font-bold uppercase tracking-widest text-sm italic">Gestione Mezzi nel Cloud</h3>
                            <span className="bg-orange-500 text-[10px] px-3 py-1 rounded-full font-black uppercase tracking-widest shadow-lg">{vehicles.length} Totali</span>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-left">
                                <thead className="bg-slate-50 border-b border-slate-100 text-[10px] uppercase font-bold text-slate-400 tracking-widest">
                                    <tr>
                                        <th className="p-8">Informazioni Mezzo</th>
                                        <th className="p-8">Codice / Targa</th>
                                        <th className="p-8 text-right">Azioni</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-50">
                                    {vehicles.sort((a,b) => b.createdAt - a.createdAt).map(v => (
                                        <tr key={v.id} className="hover:bg-slate-50/50 transition-colors">
                                            <td className="p-8">
                                                <div className="font-bold text-slate-800 text-lg leading-tight mb-1">{v.description}</div>
                                                <div className="text-orange-600 font-black text-xl">€ {Number(v.price).toLocaleString('it-IT')}</div>
                                            </td>
                                            <td className="p-8 font-mono">
                                                <div className="text-xs text-slate-400 mb-1 font-bold">{v.adCode || '---'}</div>
                                                <div className="bg-slate-100 inline-block px-3 py-1 rounded-lg text-xs font-bold uppercase">{v.plate}</div>
                                            </td>
                                            <td className="p-8 text-right">
                                                <button onClick={() => confirm("Eliminare definitivamente?") && onDelete(v.id)} className="w-12 h-12 rounded-2xl bg-red-50 text-red-400 hover:bg-red-500 hover:text-white transition-all shadow-sm">
                                                    <i className="fa-solid fa-trash-can"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                    {vehicles.length === 0 && (
                                        <tr><td colSpan="3" className="p-20 text-center text-slate-300 italic">Nessun mezzo in archivio</td></tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

